# Generate Python Models on PR
# When .avsc schema files change, regenerate Python models and commit to PR branch

name: Generate Models on PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-models:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Checkout PR head branch for committing changes back
          ref: ${{ github.head_ref }}
          # Use token with write permissions
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for Avro schema changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            schemas:
              - added|modified|deleted: 'schemas/**/*.avsc'
          list-files: shell

      - name: Set up Python
        if: steps.changes.outputs.schemas == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dc-avro CLI
        if: steps.changes.outputs.schemas == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install "dataclasses-avroschema[cli]>=0.66"

      - name: Lint Avro schemas
        if: steps.changes.outputs.schemas == 'true'
        run: |
          echo "ðŸ” Validating Avro schemas..."
          SCHEMAS=$(find schemas -name "*.avsc" 2>/dev/null || true)
          if [ -z "$SCHEMAS" ]; then
            echo "âš ï¸ No .avsc files found in schemas/"
            exit 0
          fi
          dc-avro lint $SCHEMAS
          echo "âœ… All schemas valid"

      - name: Generate Python models
        if: steps.changes.outputs.schemas == 'true'
        run: |
          echo "ðŸ”§ Generating Python models..."
          echo "ðŸ“ Changed schema files: ${{ steps.changes.outputs.schemas_files }}"
          
          # Clean existing generated models
          rm -rf src/cz/trading/model
          mkdir -p src/cz/trading/model
          
          for avsc in $(find schemas -name "*.avsc"); do
            # schemas/kafka/raw-signal/key.avsc -> src/cz/trading/model/kafka/raw-signal/key.py
            REL_PATH="${avsc#schemas/}"
            OUT_DIR="src/cz/trading/model/$(dirname "$REL_PATH")"
            OUT_FILE="$OUT_DIR/$(basename "$avsc" .avsc).py"
            
            mkdir -p "$OUT_DIR"
            
            echo "  $avsc -> $OUT_FILE"
            dc-avro generate-model --path "$avsc" --model-type pydantic > "$OUT_FILE"
            
            # Create __init__.py if not exists
            if [ ! -f "$OUT_DIR/__init__.py" ]; then
              echo "# Generated by dc-avro" > "$OUT_DIR/__init__.py"
            fi
          done
          
          # Create namespace package init files
          for dir in src/cz src/cz/trading src/cz/trading/model; do
            if [ ! -f "$dir/__init__.py" ]; then
              echo "# Namespace package" > "$dir/__init__.py"
            fi
          done
          
          echo "âœ… Models generated"

      - name: Check for generated file changes
        if: steps.changes.outputs.schemas == 'true'
        id: generated
        run: |
          git add src/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes in generated files"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Generated files have changes:"
            git diff --staged --name-only
          fi

      - name: Commit generated models
        if: steps.changes.outputs.schemas == 'true' && steps.generated.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "chore: regenerate Python models from Avro schemas [skip ci]"
          git push
          echo "âœ… Generated models committed to PR branch"

      - name: Summary
        if: always()
        run: |
          echo "### ðŸ”„ Model Generation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.schemas }}" == "true" ]; then
            echo "**Schema changes detected:** Yes" >> $GITHUB_STEP_SUMMARY
            echo "**Changed files:** \`${{ steps.changes.outputs.schemas_files }}\`" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.generated.outputs.has_changes }}" == "true" ]; then
              echo "**Generated models committed:** âœ… Yes" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Generated models committed:** â„¹ï¸ No changes needed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Schema changes detected:** No" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸ No .avsc files were added, modified, or deleted" >> $GITHUB_STEP_SUMMARY
          fi
